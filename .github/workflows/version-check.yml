name: Schema Version Check

on:
  pull_request:
    paths:
      - 'bcsvw/schema.json'
      - 'collection/schema.json'
      - 'dataset/schema.json'
      - 'studyflow/schema.linkml.yaml'

jobs:
  check-version:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}
      
      - name: Setup Python with uv
        uses: astral-sh/setup-uv@v4
      
      - name: Check if version was bumped
        run: |
          echo "Checking for schema changes and version bumps..."
          
          # Function to check version bump for a schema
          check_schema_version() {
            local schema_path=$1
            local schema_name=$(dirname $schema_path)
            
            if git diff origin/${{ github.base_ref }} HEAD --name-only | grep -q "$schema_path"; then
              echo "üìù $schema_path was modified"
              
              # Get old and new versions
              old_version=$(git show origin/${{ github.base_ref }}:$schema_path | grep '"version"' | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
              new_version=$(grep '"version"' $schema_path | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
              
              echo "  Old version: $old_version"
              echo "  New version: $new_version"
              
              if [ "$old_version" = "$new_version" ]; then
                echo "‚ùå ERROR: Version not bumped for $schema_name"
                echo ""
                echo "Please run: python scripts/version_schema.py $schema_name --message 'Description of changes'"
                exit 1
              else
                echo "‚úÖ Version bumped: $old_version ‚Üí $new_version"
                
                # Check if old version was archived
                archived_file="$schema_name/versions/schema-v$old_version.json"
                if [ ! -f "$archived_file" ]; then
                  echo "‚ùå ERROR: Old version not archived to $archived_file"
                  exit 1
                else
                  echo "‚úÖ Old version archived to $archived_file"
                fi
                
                # Check if CHANGELOG was updated
                changelog="$schema_name/CHANGELOG.md"
                if git diff origin/${{ github.base_ref }} HEAD --name-only | grep -q "$changelog"; then
                  if grep -q "\[$new_version\]" "$changelog"; then
                    echo "‚úÖ CHANGELOG updated with version $new_version"
                  else
                    echo "‚ö†Ô∏è  WARNING: CHANGELOG modified but doesn't contain [$new_version]"
                  fi
                else
                  echo "‚ö†Ô∏è  WARNING: CHANGELOG not updated"
                fi
              fi
              echo ""
            fi
          }
          
          # Check each schema
          check_schema_version "bcsvw/schema.json"
          check_schema_version "collection/schema.json"
          check_schema_version "dataset/schema.json"
          
          echo "‚úÖ All schema versions are properly bumped"
